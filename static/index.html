<! doctype html>
<html>
  <head>
  </head>
  <body>
    <script>
      var lightState = [false,false,false,false,false,false]

			getLights().then(function(response) {
				var numberOfLights = Object.keys(JSON.parse(response)).length
				makeButtonsForLights(numberOfLights)
			}, function(error) {
				console.log('Error!', response)
			})

			function makeButtonsForLights(numberOfLights) {
				var body = document.getElementsByTagName('body')[0],
						i,
					  clicker
        for (i=1; i<=numberOfLights; i++) {
					clicker = document.createElement('button')
					clicker.dataset.lightid = i
					clicker.innerHTML = "Toggle light " + i
          clicker.onclick = hitTheLights
					body.appendChild(clicker)
        }
			}

      function get(url) {
				return new Promise(function(resolve, reject) {
					var req = new XMLHttpRequest()
					req.open('GET', url)

					req.onload = function () {
						if (req.status == 200) {
							resolve(req.response)
						} else {
							reject(Error(req.statusText))
						}
					}

					req.onerror = function () {
						reject(Error("Network error"))
					}

					req.send()
				})
			}

      function getLights() {
        return get("http://192.168.1.108/api/6c3N6aVAYAIvGrpe4uF9v3PR-l7udDtKDKX0veiQ/lights/")
      }

      function alertContents() {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          if (httpRequest.status === 200) {
            return httpRequest.responseText
          } else {
            alert('There was a problem with the request.')
          }
        }
      }

      function hitTheLights(event) {
        console.log(event)
        var lightid = parseInt(event.target.dataset.lightid)
        if (lightState[lightid]) {
          turnOff(lightid)
        } else {
          turnOn(lightid)
        }
        lightState[lightid] = !lightState[lightid]
      }


      function turnOn(lightid) {
        httpRequest = new XMLHttpRequest();
        httpRequest.open("PUT", "http://192.168.1.108/api/6c3N6aVAYAIvGrpe4uF9v3PR-l7udDtKDKX0veiQ/lights/" + lightid + "/state", true)
        httpRequest.send(JSON.stringify({
          on: true,
          sat: 254,
          bri: 200,
          hue: 50000
        }))
      }

      function turnOff(lightid) {
        httpRequest = new XMLHttpRequest();
        httpRequest.open("PUT", "http://192.168.1.108/api/6c3N6aVAYAIvGrpe4uF9v3PR-l7udDtKDKX0veiQ/lights/" + lightid + "/state", true)
        httpRequest.send(JSON.stringify({on: false}));
      }
    </script>
  </body>
</html>
